# #################################################################################################################################################################
# Remarks:     This version requests user input for a given Log Analytic table name. It queries the LA table based on specified time period.  
#              Name of event hub topic is derived from the user input Log Analytics table name (suffix 'am-' is added to lower case table name provided by the user).
#              A Rest API call is made and the output from the LA query is submitted to event hub.
#              Row by row is iterated and size is calculated for a group of rows not to exceed ~0.97MB before submission to Event Hub. 
# 
# Constraints: Event hub can process maximum 1MB per message or 1000 events per second at this time. Log Analytics query can return max 500K rows or 64MB. However
#              the event hub constraints are expected to be more prominent.
#
# Hardcoded $LogAnalyticsWorkspaceId and AccessPolicyName/Key.
###################################################################################################################################################################


PARAM(     
           
    [Parameter(Mandatory=$false)] $LogAnalyticsWorkspaceId="XXX",            
    [Parameter(Mandatory=$false)] $AccessPolicyName="RootManageSharedAccessKey",
    [Parameter(Mandatory=$false)] $Access_Policy_Key="XXX"
   
 
 )


#########Functions

Function get-SAStoken{

    Param(
        $EventHubNamespace,
        $EventHub,
        $Access_Policy_Name,
        $Access_Policy_Key

    )
    [Reflection.Assembly]::LoadWithPartialName("System.Web")| out-null
    $URI="$($EventHubNamespace).servicebus.windows.net/$($EventHub)"
    #Token expires now+300
    $Expires=([DateTimeOffset]::Now.ToUnixTimeSeconds())+3000
    $SignatureString=[System.Web.HttpUtility]::UrlEncode($URI)+ "`n" + [string]$Expires
    $HMAC = New-Object System.Security.Cryptography.HMACSHA256
    $HMAC.key = [Text.Encoding]::ASCII.GetBytes($Access_Policy_Key)
    $Signature = $HMAC.ComputeHash([Text.Encoding]::ASCII.GetBytes($SignatureString))
    $Signature = [Convert]::ToBase64String($Signature)
    $SASToken = "SharedAccessSignature sr=" + [System.Web.HttpUtility]::UrlEncode($URI) + "&sig=" + [System.Web.HttpUtility]::UrlEncode($Signature) + "&se=" + $Expires + "&skn=" + $Access_Policy_Name
    
    return $SASToken

}

function send-datatoEventHub{
    param(
    $token,
    $row,
    $Namespace,
    $EventHub
    )
    Write-Host "Calling Rest API to send data to event hub topic $EventHub..."
    $paras_DE = @{
   
    Uri = "https://$($Namespace).servicebus.windows.net/$($EventHub)/messages?api-version=2014-01"

    ContentType = 'application/json'
    Method = 'POST'
    headers = @{
        authorization = $token
        
    }

    body = $row

           
    }
    $result = Invoke-RestMethod @paras_DE
    Write-Host $result + "--------- Data sent to Event Hub $EventHub."

}

$allehubtopic = @()

function GetListHub{
    Param(
    $EventHubNamespace,
    $RGName
    )

    $hubdata = Get-AzEventHub -Namespace $EventHubNamespace -ResourceGroupName $RGName
    
    return $hubdata

}

Function QueryLogAnalyticsSend {  
        Param(
        $TableName, 
        $startperiod, 
        $endperiod, 
        $LogAnalyticsWorkspaceId
        )
        
        $elapsedvar1 = Get-Date

        Write-Host "Executing query on Log Analytics, table $TableName..."
        
        $query = "$($TableName)| where TimeGenerated >= datetime($startperiod) and TimeGenerated <= datetime($endperiod)"
        $output = (Invoke-AzOperationalInsightsQuery -WorkspaceId $LogAnalyticsWorkspaceId -Query $query).Results

        $arrayrows = @()
        $total_size_sent = 0
        $current_size = 0
        $allowed_size = 1024 * 1024 - 3000
        Write-Host "Allowed size is $allowed_size"     

        foreach ($row in $output) 
        {
                
                $irow++
                $converted_row = $row | ConvertTo-Json
                $row_size = [System.Text.Encoding]::UTF8.GetByteCount($converted_row)
                $current_size = $current_size+$row_size
                $total_size_sent = $total_size_sent + $current_size

                            
                IF ($current_size -gt $allowed_size) 
                {
                    Write-Host "*** Current size to be sent: $current_size Bytes   Table is: $TableName *** "
                            
                    $SAStoken = get-SAStoken -EventHubNamespace $EventHubNamespace -EventHub $EventHub -Access_Policy_Name $AccessPolicyName -Access_Policy_Key $Access_Policy_Key
                   
                    send-datatoEventHub -token $SAStoken -row $arrayrows -Namespace $EventHubNamespace -EventHub $EventHub
                    $current_size = 0
                    $arrayrows = @()
                }

                $arrayrows = $arrayrows + $converted_row
 
        }

         Write-Host "*** Current size to be sent: $current_size Bytes   Table is: $TableName *** "
                            
         $SAStoken = get-SAStoken -EventHubNamespace $EventHubNamespace -EventHub $EventHub -Access_Policy_Name $AccessPolicyName -Access_Policy_Key $Access_Policy_Key
                   
         send-datatoEventHub -token $SAStoken -row $arrayrows -Namespace $EventHubNamespace -EventHub $EventHub

         $elapsedvar2 = Get-Date
         $elapsetime = $elapsedvar2 - $elapsedvar1
         $total_size_sent_mb = $total_size_sent
         
         Write-Host "Elapsed time:$elapsetime      Total size sent:$total_size_sent Bytes"

}

<##############
      MAIN()
###############>

$EventHubNamespace = Read-Host -Prompt "Enter eventhubnamespace"
$TableName         = Read-Host -Prompt "Log Analytics Table(CASE SENSITIVE)"
$startperiod = Read-Host -Prompt "Log export start date YYYY-MM-DD HH:MM:SS"
$endperiod   = Read-Host -Prompt "Log export end   date YYYY-MM-DD HH:MM:SS"

$makehub = $TableName.ToLower()
$EventHub = "am-"+$makehub
  
$context = Get-AzContext

if(!$context){
    Connect-AzAccount
    $context = Get-AzContext
}

$SubscriptionId = $context.Subscription.Id

#Get All the Tables from LA Workspace
$queryAllTables = 'search *| distinct $table| sort by $table asc nulls last'

$resultsAllTables = (Invoke-AzOperationalInsightsQuery -WorkspaceId $LogAnalyticsWorkspaceId -Query $queryAllTables).Results

$RGName = ""
$loc = ""
$workspacename = ""
$workspacedetails = Get-AzOperationalInsightsWorkspace
foreach ($i in $workspacedetails) {
    if($i.CustomerId -eq $LogAnalyticsWorkspaceId) {
        $RGName = $i.ResourceGroupName
        $loc = $i.Location
        $workspacename = $i.Name
        }
    }


QueryLogAnalyticsSend -TableName $TableName -startperiod $startperiod -endperiod $endperiod -LogAnalyticsWorkspaceId $LogAnalyticsWorkspaceId




